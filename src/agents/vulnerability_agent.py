"""Vulnerability Analysis Agent for comprehensive CVE assessment.

This agent combines data from NVD, VirusTotal, and CISA KEV to provide
comprehensive vulnerability analysis including severity, exploitation status,
and prioritization recommendations.
"""

import os
import re
from typing import List, Dict, Optional, Any, Annotated
from dotenv import load_dotenv
from langchain_anthropic import ChatAnthropic
from langchain.agents import AgentExecutor, create_tool_calling_agent
from langchain.prompts import ChatPromptTemplate
from langchain_core.tools import tool
import logging

from ..tools.nvd_client import NVDClient
from ..tools.virustotal_client import VirusTotalClient
from ..tools.cisa_kev_client import CISAKEVClient
from ..models.schemas import CVEDetail, ExploitationStatus, VulnerabilityAnalysis

load_dotenv()
logger = logging.getLogger(__name__)


# ============================================================================
# Initialize Clients
# ============================================================================

_nvd_client = None
_vt_client = None
_kev_client = None


def get_nvd_client() -> NVDClient:
    """Get or create NVD client instance."""
    global _nvd_client
    if _nvd_client is None:
        _nvd_client = NVDClient()
    return _nvd_client


def get_vt_client() -> VirusTotalClient:
    """Get or create VirusTotal client instance."""
    global _vt_client
    if _vt_client is None:
        _vt_client = VirusTotalClient()
    return _vt_client


def get_kev_client() -> CISAKEVClient:
    """Get or create CISA KEV client instance."""
    global _kev_client
    if _kev_client is None:
        _kev_client = CISAKEVClient()
    return _kev_client


# ============================================================================
# Tool Definitions
# ============================================================================


@tool
def get_cve_details(
    cve_id: Annotated[str, "CVE identifier (e.g., CVE-2024-12345)"]
) -> Dict[str, Any]:
    """Get detailed information about a CVE from NVD.

    Use this tool to retrieve CVE details including CVSS score, severity,
    description, affected products, and references.

    Args:
        cve_id: CVE identifier (e.g., "CVE-2024-12345")

    Returns:
        Dictionary with CVE details from NVD

    Examples:
        - "Get details for CVE-2024-1234"
        - "What is the CVSS score of CVE-2024-5678?"
        - "Show me CVE-2024-9999 information"
    """
    try:
        client = get_nvd_client()
        cve = client.get_cve(cve_id)

        if cve:
            return cve.model_dump()
        else:
            return {"error": f"CVE {cve_id} not found in NVD"}

    except Exception as e:
        logger.error(f"Error getting CVE details for {cve_id}: {e}")
        return {"error": str(e)}


@tool
def check_virustotal(
    cve_id: Annotated[str, "CVE identifier to check in VirusTotal"]
) -> Dict[str, Any]:
    """Check if a CVE has exploits or malware samples in VirusTotal.

    Use this tool to determine if a CVE is being actively exploited based on
    VirusTotal's malware and exploit database.

    Args:
        cve_id: CVE identifier

    Returns:
        Dictionary with exploitation evidence from VirusTotal

    Examples:
        - "Check if CVE-2024-1234 has exploits in VirusTotal"
        - "Is CVE-2024-5678 being exploited?"
    """
    try:
        client = get_vt_client()
        result = client.check_exploitation(cve_id)
        return result

    except Exception as e:
        logger.error(f"Error checking VirusTotal for {cve_id}: {e}")
        return {"error": str(e), "exploit_detected": False}


@tool
def check_cisa_kev(
    cve_id: Annotated[str, "CVE identifier to check in CISA KEV catalog"]
) -> Dict[str, Any]:
    """Check if a CVE is in CISA's Known Exploited Vulnerabilities catalog.

    Use this tool to determine if CISA has confirmed active exploitation of
    this CVE in the wild. CVEs in KEV require immediate attention.

    Args:
        cve_id: CVE identifier

    Returns:
        Dictionary with KEV status and details

    Examples:
        - "Is CVE-2024-1234 in CISA KEV?"
        - "Check if CVE-2024-5678 is actively exploited"
    """
    try:
        client = get_kev_client()
        in_kev = client.is_in_kev(cve_id)

        result = {"cve_id": cve_id, "in_kev": in_kev}

        if in_kev:
            details = client.get_kev_details(cve_id)
            result.update(details or {})

        return result

    except Exception as e:
        logger.error(f"Error checking CISA KEV for {cve_id}: {e}")
        return {"error": str(e), "in_kev": False}


@tool
def prioritize_vulnerabilities(
    cve_ids: Annotated[List[str], "List of CVE identifiers to prioritize"]
) -> List[Dict[str, Any]]:
    """Prioritize multiple CVEs based on severity and exploitation status.

    Use this tool to analyze and rank multiple CVEs by combining CVSS scores,
    exploitation evidence, and CISA KEV status.

    Args:
        cve_ids: List of CVE identifiers

    Returns:
        List of CVEs with priority scores (0-100), sorted by priority

    Examples:
        - "Prioritize these CVEs: CVE-2024-1234, CVE-2024-5678, CVE-2024-9999"
        - "Rank these vulnerabilities by risk"
    """
    try:
        nvd_client = get_nvd_client()
        vt_client = get_vt_client()
        kev_client = get_kev_client()

        results = []

        for cve_id in cve_ids:
            # Get CVE details
            cve = nvd_client.get_cve(cve_id)
            if not cve:
                logger.warning(f"CVE {cve_id} not found, skipping")
                continue

            # Check exploitation status
            vt_result = vt_client.check_exploitation(cve_id)
            in_kev = kev_client.is_in_kev(cve_id)

            # Calculate priority score (0-100)
            priority_score = calculate_priority_score(
                cvss_score=cve.cvss_score,
                in_kev=in_kev,
                vt_detections=vt_result.get("malicious_count", 0),
            )

            results.append(
                {
                    "cve_id": cve_id,
                    "cvss_score": cve.cvss_score,
                    "cvss_severity": cve.cvss_severity,
                    "in_kev": in_kev,
                    "vt_detections": vt_result.get("malicious_count", 0),
                    "priority_score": priority_score,
                    "recommendation": get_recommendation(priority_score, in_kev),
                }
            )

        # Sort by priority score (highest first)
        results.sort(key=lambda x: x["priority_score"], reverse=True)

        logger.info(f"Prioritized {len(results)} CVEs")
        return results

    except Exception as e:
        logger.error(f"Error prioritizing vulnerabilities: {e}")
        return [{"error": str(e)}]


@tool
def analyze_cve(
    cve_id: Annotated[str, "CVE identifier to analyze comprehensively"]
) -> Dict[str, Any]:
    """Perform comprehensive analysis of a CVE.

    Use this tool to get complete vulnerability assessment including NVD details,
    exploitation status from VirusTotal and CISA KEV, and prioritization recommendation.

    Args:
        cve_id: CVE identifier

    Returns:
        Complete vulnerability analysis

    Examples:
        - "Analyze CVE-2024-1234"
        - "Give me a full assessment of CVE-2024-5678"
    """
    try:
        # Get CVE details from NVD
        nvd_client = get_nvd_client()
        cve = nvd_client.get_cve(cve_id)

        if not cve:
            return {"error": f"CVE {cve_id} not found in NVD"}

        # Check exploitation status
        vt_client = get_vt_client()
        vt_result = vt_client.check_exploitation(cve_id)

        kev_client = get_kev_client()
        in_kev = kev_client.is_in_kev(cve_id)
        kev_details = kev_client.get_kev_details(cve_id) if in_kev else None

        # Calculate priority
        priority_score = calculate_priority_score(
            cvss_score=cve.cvss_score,
            in_kev=in_kev,
            vt_detections=vt_result.get("malicious_count", 0),
        )

        # Build comprehensive analysis
        analysis = {
            "cve_id": cve_id,
            "nvd_details": cve.model_dump(),
            "exploitation_status": {
                "in_cisa_kev": in_kev,
                "kev_details": kev_details,
                "virustotal_detections": vt_result.get("malicious_count", 0),
                "exploit_detected": vt_result.get("exploit_detected", False),
            },
            "priority_score": priority_score,
            "recommendation": get_recommendation(priority_score, in_kev),
            "summary": generate_summary(cve, in_kev, vt_result, priority_score),
        }

        logger.info(f"Completed analysis for {cve_id} (priority: {priority_score})")
        return analysis

    except Exception as e:
        logger.error(f"Error analyzing CVE {cve_id}: {e}")
        return {"error": str(e)}


@tool
def extract_cves_from_text(
    text: Annotated[str, "Text to extract CVE identifiers from"]
) -> List[str]:
    """Extract CVE identifiers from text.

    Use this tool to find all CVE IDs mentioned in incident descriptions,
    vulnerability reports, or other text.

    Args:
        text: Text containing potential CVE identifiers

    Returns:
        List of unique CVE identifiers found

    Examples:
        - "Extract CVEs from this text: 'Found CVE-2024-1234 and CVE-2024-5678 on server'"
        - "Find CVE IDs in this incident description"
    """
    # Regex pattern for CVE IDs
    pattern = r"CVE-\d{4}-\d{4,7}"
    cves = re.findall(pattern, text, re.IGNORECASE)

    # Convert to uppercase and remove duplicates
    unique_cves = list(set([cve.upper() for cve in cves]))

    logger.info(f"Extracted {len(unique_cves)} unique CVEs from text")
    return unique_cves


# ============================================================================
# Helper Functions
# ============================================================================


def calculate_priority_score(
    cvss_score: Optional[float], in_kev: bool, vt_detections: int
) -> float:
    """Calculate priority score (0-100) for a CVE.

    Scoring factors:
    - CVSS score: 0-50 points (normalized from 0-10)
    - In CISA KEV: +30 points
    - VirusTotal detections: +20 points (if any malicious samples)

    Args:
        cvss_score: CVSS base score (0-10)
        in_kev: Whether CVE is in CISA KEV catalog
        vt_detections: Number of malicious samples in VirusTotal

    Returns:
        Priority score (0-100)
    """
    score = 0.0

    # CVSS score component (0-50 points)
    if cvss_score:
        score += (cvss_score / 10.0) * 50

    # CISA KEV component (+30 points)
    if in_kev:
        score += 30

    # VirusTotal component (+20 points if exploited)
    if vt_detections > 0:
        score += 20

    return round(score, 1)


def get_recommendation(priority_score: float, in_kev: bool) -> str:
    """Get remediation recommendation based on priority score.

    Args:
        priority_score: Priority score (0-100)
        in_kev: Whether CVE is in CISA KEV

    Returns:
        Recommendation string
    """
    if in_kev:
        return "CRITICAL: In CISA KEV - patch immediately (within 24-48 hours)"
    elif priority_score >= 80:
        return "HIGH PRIORITY: Patch within 1 week"
    elif priority_score >= 60:
        return "MEDIUM PRIORITY: Patch within 30 days"
    elif priority_score >= 40:
        return "LOW PRIORITY: Patch within 90 days or next maintenance window"
    else:
        return "INFORMATIONAL: Monitor for changes, patch when convenient"


def generate_summary(
    cve: CVEDetail, in_kev: bool, vt_result: Dict[str, Any], priority_score: float
) -> str:
    """Generate human-readable summary of CVE analysis.

    Args:
        cve: CVE details from NVD
        in_kev: Whether in CISA KEV
        vt_result: VirusTotal results
        priority_score: Calculated priority score

    Returns:
        Summary string
    """
    summary_parts = []

    # Severity and score
    summary_parts.append(
        f"{cve.cve_id} is rated {cve.cvss_severity or 'UNKNOWN'} "
        f"with CVSS score {cve.cvss_score or 'N/A'}."
    )

    # Exploitation status
    if in_kev:
        summary_parts.append("⚠️  This CVE is in CISA KEV - actively exploited in the wild!")
    elif vt_result.get("exploit_detected"):
        summary_parts.append(
            f"⚠️  Exploit detected in VirusTotal ({vt_result.get('malicious_count')} samples)."
        )
    else:
        summary_parts.append("No active exploitation detected.")

    # Priority
    summary_parts.append(f"Priority score: {priority_score}/100.")

    return " ".join(summary_parts)


# ============================================================================
# Agent Definition
# ============================================================================


class VulnerabilityAgent:
    """Agent for comprehensive vulnerability analysis.

    This agent combines data from NVD, VirusTotal, and CISA KEV to provide
    complete vulnerability assessments including exploitation status and
    prioritization recommendations.
    """

    def __init__(self, model: str = "claude-3-5-sonnet-20241022", temperature: float = 0):
        """Initialize Vulnerability Agent.

        Args:
            model: Anthropic model to use
            temperature: Model temperature
        """
        self.model_name = model
        self.temperature = temperature

        # Initialize LLM
        self.llm = ChatAnthropic(
            model=model,
            temperature=temperature,
            api_key=os.getenv("ANTHROPIC_API_KEY"),
        )

        # Define tools
        self.tools = [
            get_cve_details,
            check_virustotal,
            check_cisa_kev,
            prioritize_vulnerabilities,
            analyze_cve,
            extract_cves_from_text,
        ]

        # Create prompt
        self.prompt = ChatPromptTemplate.from_messages(
            [
                (
                    "system",
                    """You are a cybersecurity vulnerability analyst specializing in CVE assessment.

Your capabilities:
1. Get CVE details from NVD (CVSS scores, descriptions, affected products)
2. Check exploitation status in VirusTotal
3. Verify if CVE is in CISA Known Exploited Vulnerabilities catalog
4. Prioritize multiple CVEs based on severity and exploitation
5. Perform comprehensive CVE analysis
6. Extract CVE IDs from text

When analyzing vulnerabilities:
- Always check CISA KEV status first - KEV CVEs require immediate action
- Consider both CVSS score AND exploitation status for prioritization
- Provide clear, actionable recommendations
- Highlight critical findings (KEV status, high CVSS, active exploitation)
- Be concise but thorough

Priority levels:
- 80-100: Critical/High Priority (patch within 1 week)
- 60-79: Medium Priority (patch within 30 days)
- 40-59: Low Priority (patch within 90 days)
- 0-39: Informational (patch when convenient)

CISA KEV CVEs always get highest priority regardless of CVSS score.
""",
                ),
                ("human", "{input}"),
                ("placeholder", "{agent_scratchpad}"),
            ]
        )

        # Create agent
        self.agent = create_tool_calling_agent(self.llm, self.tools, self.prompt)

        # Create executor
        self.executor = AgentExecutor(
            agent=self.agent,
            tools=self.tools,
            verbose=True,
            handle_parsing_errors=True,
            max_iterations=5,
        )

        logger.info(f"Vulnerability agent initialized with {len(self.tools)} tools")

    def query(self, user_input: str) -> str:
        """Process vulnerability analysis query.

        Args:
            user_input: User's query

        Returns:
            Analysis response
        """
        try:
            result = self.executor.invoke({"input": user_input})
            return result.get("output", "No response generated")

        except Exception as e:
            logger.error(f"Error processing query: {e}")
            return f"Error processing query: {e}"

    def analyze_cves(self, cve_ids: List[str]) -> List[VulnerabilityAnalysis]:
        """Analyze multiple CVEs (programmatic interface for LangGraph).

        Args:
            cve_ids: List of CVE identifiers

        Returns:
            List of VulnerabilityAnalysis objects
        """
        results = []

        for cve_id in cve_ids:
            try:
                # Get CVE details
                nvd_client = get_nvd_client()
                cve = nvd_client.get_cve(cve_id)

                if not cve:
                    continue

                # Check exploitation
                vt_client = get_vt_client()
                vt_result = vt_client.check_exploitation(cve_id)

                kev_client = get_kev_client()
                in_kev = kev_client.is_in_kev(cve_id)

                # Create exploitation status
                exploit_status = ExploitationStatus(
                    cve_id=cve_id,
                    in_cisa_kev=in_kev,
                    virustotal_detections=vt_result.get("malicious_count", 0),
                    exploit_available=vt_result.get("exploit_detected", False),
                    actively_exploited=in_kev or vt_result.get("exploit_detected", False),
                )

                # Calculate priority
                priority_score = calculate_priority_score(
                    cvss_score=cve.cvss_score,
                    in_kev=in_kev,
                    vt_detections=vt_result.get("malicious_count", 0),
                )

                # Create analysis
                analysis = VulnerabilityAnalysis(
                    cve_detail=cve,
                    exploitation_status=exploit_status,
                    priority_score=priority_score,
                    recommendation=get_recommendation(priority_score, in_kev),
                )

                results.append(analysis)

            except Exception as e:
                logger.error(f"Error analyzing {cve_id}: {e}")
                continue

        return results
