"""Tests for Vulnerability Analysis Agent."""

import pytest
from unittest.mock import Mock, patch
from src.agents.vulnerability_agent import (
    VulnerabilityAgent,
    calculate_priority_score,
    get_recommendation,
)
from src.models.schemas import CVEDetail, ExploitationStatus


class TestPriorityScoring:
    """Test priority score calculations."""

    def test_calculate_priority_score_with_kev(self):
        """Test priority score for CVE in CISA KEV."""
        score = calculate_priority_score(cvss_score=9.8, in_kev=True, vt_detections=0)

        assert score > 70  # Should be high priority
        assert score <= 100

    def test_calculate_priority_score_high_cvss(self):
        """Test priority score for high CVSS only."""
        score = calculate_priority_score(cvss_score=9.8, in_kev=False, vt_detections=0)

        assert score >= 40  # Moderate to high
        assert score < 70  # But not critical without KEV

    def test_calculate_priority_score_low(self):
        """Test priority score for low severity CVE."""
        score = calculate_priority_score(cvss_score=3.1, in_kev=False, vt_detections=0)

        assert score < 40  # Should be low priority

    def test_get_recommendation_critical(self):
        """Test recommendation for critical CVE."""
        rec = get_recommendation(priority_score=85, in_kev=True)

        assert "CRITICAL" in rec or "KEV" in rec
        assert "immediately" in rec.lower() or "24" in rec

    def test_get_recommendation_low(self):
        """Test recommendation for low priority CVE."""
        rec = get_recommendation(priority_score=25, in_kev=False)

        assert "90 days" in rec or "INFORMATIONAL" in rec


class TestVulnerabilityAgent:
    """Test Vulnerability Agent initialization and basic functions."""

    def test_agent_initialization(self):
        """Test agent initializes correctly."""
        agent = VulnerabilityAgent()

        assert agent is not None
        assert len(agent.tools) == 6  # Should have 6 tools

    @patch("src.tools.nvd_client.NVDClient.get_cve")
    @patch("src.tools.virustotal_client.VirusTotalClient.check_exploitation")
    @patch("src.tools.cisa_kev_client.CISAKEVClient.is_in_kev")
    def test_analyze_cves_programmatic(
        self, mock_kev, mock_vt, mock_nvd
    ):
        """Test programmatic CVE analysis."""
        # Mock NVD response
        mock_nvd.return_value = CVEDetail(
            cve_id="CVE-2024-TEST",
            description="Test vulnerability",
            cvss_score=7.5,
            cvss_severity="HIGH",
            published_date="2024-01-01",
            last_modified="2024-01-01",
        )

        # Mock VirusTotal response
        mock_vt.return_value = {
            "cve_id": "CVE-2024-TEST",
            "exploit_detected": False,
            "malicious_count": 0,
        }

        # Mock CISA KEV response
        mock_kev.return_value = False

        agent = VulnerabilityAgent()
        results = agent.analyze_cves(["CVE-2024-TEST"])

        assert len(results) == 1
        assert results[0].cve_detail.cve_id == "CVE-2024-TEST"
        assert results[0].priority_score > 0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
